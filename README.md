# AnnotaPipe

**æ ‡æ³¨æ•°æ®è‡ªåŠ¨åŒ–å¤„ç†æµæ°´çº¿** - ä¼ä¸šçº§æ•°æ®å¤„ç†è§£å†³æ–¹æ¡ˆï¼Œç”¨äºä» DataWeave å¹³å°ä¸‹è½½æ•°æ®ã€ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ã€å¤„ç†å’Œæ£€æŸ¥æ ‡æ³¨è´¨é‡ã€‚

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)
[![Status](https://img.shields.io/badge/Status-Production-success.svg)]()

> ğŸ‰ **é¡¹ç›®çŠ¶æ€**: v1.0 ç”Ÿäº§å°±ç»ªï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®å¤„ç†

---

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#-åŠŸèƒ½ç‰¹æ€§)
- [é¡¹ç›®ç»“æ„](#-é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
- [è¿è¡Œæ¨¡å¼](#ï¸-è¿è¡Œæ¨¡å¼)
- [é…ç½®è¯´æ˜](#-é…ç½®è¯´æ˜)
- [å¤„ç†æµç¨‹](#-å¤„ç†æµç¨‹)
- [æ•°æ®å®Œæ•´æ€§ä¿æŠ¤](#-æ•°æ®å®Œæ•´æ€§ä¿æŠ¤)
- [è¾…åŠ©å·¥å…·](#ï¸-è¾…åŠ©å·¥å…·)
- [æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)
- [æ›´æ–°æ—¥å¿—](#-æ›´æ–°æ—¥å¿—)

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- ğŸš€ **å¤šç§è¿è¡Œæ¨¡å¼**ï¼šä¼˜åŒ–æ¨¡å¼ã€å¹¶è¡Œæ¨¡å¼ã€æµå¼æ¨¡å¼ï¼Œé€‚åº”ä¸åŒåœºæ™¯
- ğŸ“¥ **æ™ºèƒ½ä¸‹è½½**ï¼šè‡ªåŠ¨ä» DataWeave ä¸‹è½½æ ‡æ³¨æ•°æ®ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- ğŸ“¤ **é«˜æ•ˆä¸Šä¼ **ï¼šSFTP æ‰¹é‡ä¸Šä¼ åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œå®Œæ•´æ€§éªŒè¯
- ğŸ” **è´¨é‡æ£€æŸ¥**ï¼šè‡ªåŠ¨åŒ–æ ‡æ³¨è´¨é‡æ£€æŸ¥ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
- ğŸ“Š **å®æ—¶è¿½è¸ª**ï¼šé£ä¹¦å¤šç»´è¡¨æ ¼å®æ—¶åŒæ­¥ï¼Œæ”¯æŒå±æ€§å’Œè·¯å¾„ç´¯ç§¯
- ğŸ’¾ **NAS å¤‡ä»½**ï¼šè‡ªåŠ¨å¤‡ä»½åˆ°ç¾¤æ™– NASï¼Œæ”¯æŒå¢é‡å¤‡ä»½
- ğŸ“ **å®Œæ•´æ—¥å¿—**ï¼šè¯¦ç»†çš„å¤„ç†æ—¥å¿—å’Œè¿›åº¦è¿½è¸ª

### é«˜çº§ç‰¹æ€§
- âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šä¸‹è½½å’Œä¸Šä¼ å‡æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œç½‘ç»œä¸­æ–­åå¯ç»§ç»­
- âœ… **å®Œæ•´æ€§éªŒè¯**ï¼šMD5 æ ¡éªŒç¡®ä¿æ•°æ®ä¼ è¾“å®Œæ•´æ€§
- âœ… **æ™ºèƒ½é‡è¿**ï¼šSSH è¿æ¥è‡ªåŠ¨æ£€æµ‹å’Œé‡è¿
- âœ… **æ–‡ä»¶åè§„èŒƒåŒ–**ï¼šè‡ªåŠ¨å¤„ç†å¸¦åç¼€çš„æ–‡ä»¶åï¼ˆå¦‚ `_rere_0`ï¼‰
- âœ… **è·¨ç›®å½•å¤„ç†**ï¼šæ”¯æŒå°†åŒä¸€æ•°æ®åŒ…å¤„ç†åˆ°å¤šä¸ªç›®æ ‡ç›®å½•
- âœ… **å¹¶å‘æ§åˆ¶**ï¼šå¯é…ç½®çš„å¹¶å‘æ•°ï¼Œå¹³è¡¡æ•ˆç‡å’Œç¨³å®šæ€§

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
annotapipe/
â”œâ”€â”€ run_pipeline.py              # ğŸš€ å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ requirements.txt             # ğŸ“¦ Python ä¾èµ–
â”œâ”€â”€ .gitignore                   # ğŸ”’ Git å¿½ç•¥è§„åˆ™
â”‚
â”œâ”€â”€ configs/                     # âš™ï¸ é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ pipeline.yaml           # æµæ°´çº¿ä¸»é…ç½®
â”‚   â”œâ”€â”€ check_rules.yaml        # æ ‡æ³¨æ£€æŸ¥è§„åˆ™
â”‚   â”œâ”€â”€ feishu.yaml             # é£ä¹¦é…ç½®
â”‚   â”œâ”€â”€ nas_backup.yaml         # NAS å¤‡ä»½é…ç½®
â”‚   â”œâ”€â”€ upload_config.yaml      # DataWeave ä¸Šä¼ é…ç½®
â”‚   â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â””â”€â”€ README.md               # é…ç½®æ–‡æ¡£
â”‚
â”œâ”€â”€ src/                         # ğŸ“š æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ pipeline/               # æ ¸å¿ƒæµæ°´çº¿æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ runner.py           # æµæ°´çº¿è¿è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ downloader.py       # æ–‡ä»¶ä¸‹è½½å™¨
â”‚   â”‚   â”œâ”€â”€ uploader.py         # æ–‡ä»¶ä¸Šä¼ å™¨
â”‚   â”‚   â”œâ”€â”€ processor.py        # è¿œç¨‹å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ checker.py          # æ ‡æ³¨æ£€æŸ¥å™¨
â”‚   â”‚   â”œâ”€â”€ tracker.py          # é£ä¹¦è¿½è¸ªå™¨
â”‚   â”‚   â”œâ”€â”€ ssh_client.py       # SSH å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ nas_backup.py       # NAS å¤‡ä»½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ server_logger.py    # æœåŠ¡å™¨æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ state.py            # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ config.py           # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ README.md           # æ¨¡å—æ–‡æ¡£
â”‚   â”‚
â”‚   â””â”€â”€ remote_scripts/         # è¿œç¨‹æ‰§è¡Œè„šæœ¬
â”‚       â”œâ”€â”€ zip_worker.py       # ZIP å¤„ç†è„šæœ¬
â”‚       â””â”€â”€ annotation_checker.py  # æ ‡æ³¨æ£€æŸ¥è„šæœ¬
â”‚
â”œâ”€â”€ tools/                       # ğŸ› ï¸ è¾…åŠ©å·¥å…·
â”‚   â”œâ”€â”€ upload_to_dataweave.py  # DataWeave ä¸Šä¼ å·¥å…·
â”‚   â”œâ”€â”€ organize_zips.py        # ZIP æ–‡ä»¶æ•´ç†å·¥å…·
â”‚   â”œâ”€â”€ backup_to_nas.py        # NAS å¤‡ä»½å·¥å…·
â”‚   â”œâ”€â”€ annotation_stats.py     # æ ‡æ³¨ç»Ÿè®¡å·¥å…·
â”‚   â”œâ”€â”€ keyframe_counter.py     # å…³é”®å¸§è®¡æ•°å·¥å…·
â”‚   â””â”€â”€ debug_feishu.py         # é£ä¹¦è°ƒè¯•å·¥å…·
â”‚
â”œâ”€â”€ tests/                       # ğŸ§ª æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ test_download_speed.py
â”‚   â”œâ”€â”€ test_upload_speed.py
â”‚   â”œâ”€â”€ test_resume_upload.py
â”‚   â”œâ”€â”€ test_nas_backup.py
â”‚   â””â”€â”€ test_upload_speed_optimized.py
â”‚
â”œâ”€â”€ examples/                    # ğŸ“ ç¤ºä¾‹æ–‡ä»¶
â”‚   â””â”€â”€ *.json                  # ç¤ºä¾‹ JSON æ–‡ä»¶
â”‚
â””â”€â”€ batch_*.sh                   # ğŸ”„ æ‰¹å¤„ç†è„šæœ¬
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- **Python**: 3.8+
- **æ“ä½œç³»ç»Ÿ**: Linux (æ¨è Ubuntu 20.04+)
- **ç³»ç»Ÿå·¥å…·**: `cifs-utils` (ç”¨äº NAS æŒ‚è½½)

### 2. å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/EDuAPo/annotapipe.git
cd annotapipe

# å®‰è£… Python ä¾èµ–
pip install -r requirements.txt

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆç”¨äº NAS å¤‡ä»½ï¼‰
sudo apt install cifs-utils
```

### 3. é…ç½®ç¯å¢ƒ

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp configs/.env.example configs/.env

# ç¼–è¾‘ .env å¡«å…¥å®é™…å‡­è¯
vim configs/.env
```

**å¿…éœ€çš„ç¯å¢ƒå˜é‡**ï¼š
```bash
# DataWeave å‡­è¯
DATAWEAVE_USERNAME=your_username
DATAWEAVE_PASSWORD=your_password

# æœåŠ¡å™¨ SSH å‡­è¯
SERVER_PRIMARY_PASSWORD=your_ssh_password

# é£ä¹¦åº”ç”¨å‡­è¯
FEISHU_APP_ID=your_app_id
FEISHU_APP_SECRET=your_app_secret

# NAS å‡­è¯ï¼ˆå¯é€‰ï¼Œç”¨äºå¤‡ä»½ï¼‰
NAS_PASSWORD=your_nas_password
```

### 4. è¿è¡Œæµæ°´çº¿

```bash
# åŸºæœ¬ç”¨æ³•ï¼ˆæ¨èï¼‰
python run_pipeline.py --json_dir ./data

# æŒ‡å®šé…ç½®æ–‡ä»¶
python run_pipeline.py --json_dir ./data --config configs/pipeline.yaml

# å¹¶è¡Œæ¨¡å¼ï¼Œ4 ä¸ªå·¥ä½œçº¿ç¨‹
python run_pipeline.py --json_dir ./data --mode parallel --workers 4

# æµå¼æ¨¡å¼ï¼ˆé€‚åˆè°ƒè¯•ï¼‰
python run_pipeline.py --json_dir ./data --mode streaming
```

---

## âš™ï¸ è¿è¡Œæ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | å¹¶å‘ç­–ç•¥ |
|------|------|----------|----------|
| **optimized** | ä¸‹è½½å¹¶è¡Œ + æœåŠ¡å™¨æ“ä½œä¸²è¡Œï¼ˆé»˜è®¤ï¼‰ | æ¨èï¼Œå¹³è¡¡æ•ˆç‡å’Œç¨³å®šæ€§ | ä¸‹è½½é˜¶æ®µå¹¶è¡Œï¼Œå¤„ç†é˜¶æ®µä¸²è¡Œ |
| **parallel** | å…¨å¹¶è¡Œæ¨¡å¼ï¼Œå¤šçº¿ç¨‹ç‹¬ç«‹å¤„ç† | å¤§æ‰¹é‡æ•°æ®å¤„ç† | å…¨æµç¨‹å¹¶è¡Œï¼Œä½¿ç”¨è¿æ¥æ±  |
| **streaming** | æµå¼æ¨¡å¼ï¼Œé€ä¸ªå¤„ç† | è°ƒè¯•æˆ–å°æ‰¹é‡æ•°æ® | å®Œå…¨ä¸²è¡Œ |

### æ¨¡å¼é€‰æ‹©å»ºè®®

- **æ—¥å¸¸ä½¿ç”¨**: `optimized` æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
- **å¤§æ‰¹é‡å¤„ç†**: `parallel` æ¨¡å¼ + å¢åŠ  workers
- **è°ƒè¯•é—®é¢˜**: `streaming` æ¨¡å¼

---

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | ç®€å†™ | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|------|--------|------|
| `--json_dir` | `-j` | JSON æ–‡ä»¶ç›®å½•ï¼ˆå¿…éœ€ï¼‰ | - | `./data` |
| `--zip_dir` | `-z` | æœ¬åœ° ZIP ç¼“å­˜ç›®å½• | è‡ªåŠ¨ç”Ÿæˆ | `./temp/zips` |
| `--mode` | `-m` | è¿è¡Œæ¨¡å¼ | `optimized` | `parallel` |
| `--workers` | `-w` | å¹¶å‘æ•° | `3` | `4` |
| `--config` | `-c` | é…ç½®æ–‡ä»¶è·¯å¾„ | è‡ªåŠ¨æŸ¥æ‰¾ | `configs/pipeline.yaml` |

### ä½¿ç”¨ç¤ºä¾‹

```bash
# å®Œæ•´å‚æ•°ç¤ºä¾‹
python run_pipeline.py \
  --json_dir /path/to/json/files \
  --zip_dir /path/to/zip/cache \
  --mode optimized \
  --workers 3 \
  --config configs/pipeline.yaml

# ç®€åŒ–ç‰ˆæœ¬ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰
python run_pipeline.py -j ./data -m parallel -w 4
```

---

## ğŸ”§ é…ç½®è¯´æ˜

è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒ [configs/README.md](configs/README.md)

### ä¸»è¦é…ç½®æ–‡ä»¶

#### 1. pipeline.yaml - æµæ°´çº¿é…ç½®

```yaml
# æœåŠ¡å™¨é…ç½®
servers:
  primary:
    ip: "222.223.112.212"
    user: "user"
    zip_dir: "/data02/zips"
    process_dir: "/data02/process"
    final_dir: "/data02/dataset/scenesnew"

# DataWeave é…ç½®
dataweave:
  username: "${DATAWEAVE_USERNAME}"
  password: "${DATAWEAVE_PASSWORD}"
  path_templates:
    - "dataweave://my/TO_RERE/æœªä¸Šä¼ å¹³å°/{filename}"
    - "dataweave://my/TO_RERE/7Lidar_data/{filename}"

# å¤„ç†é…ç½®
pipeline:
  max_workers: 3
  rename_json: true
  zip_after_process: "rename"  # rename | delete | keep
```

#### 2. feishu.yaml - é£ä¹¦é…ç½®

```yaml
feishu:
  app_id: "${FEISHU_APP_ID}"
  app_secret: "${FEISHU_APP_SECRET}"
  app_token: "your_app_token"
  table_id: "your_table_id"
  
  # å­—æ®µæ˜ å°„
  field_mapping:
    name: "æ•°æ®åŒ…åç§°"
    annotation_status: "æ ‡æ³¨æƒ…å†µ"
    keyframe_count: "å…³é”®å¸§æ•°"
```

#### 3. nas_backup.yaml - NAS å¤‡ä»½é…ç½®

```yaml
nas:
  enabled: true
  host: "192.168.2.41"
  share: "public"
  username: "SYSC"
  
path_mappings:
  "/data02/dataset/scenesnew": "from_rere/boxes"
  "/data02/dataset/lines": "from_rere/lines"
```

---

## ğŸ“Š å¤„ç†æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JSON æ–‡ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸‹è½½ ZIP    â”‚â”€â”€â”€â”€â–¶â”‚ æœ¬åœ°ç¼“å­˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šä¼ æœåŠ¡å™¨  â”‚â”€â”€â”€â”€â–¶â”‚ æœåŠ¡å™¨ ZIP   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£å‹å¤„ç†    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´¨é‡æ£€æŸ¥    â”‚â”€â”€â”€â”€â–¶â”‚ æ£€æŸ¥æŠ¥å‘Š     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§»åŠ¨åˆ°      â”‚
â”‚ final_dir   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAS å¤‡ä»½    â”‚â”€â”€â”€â”€â–¶â”‚ å¤‡ä»½å®Œæˆ     â”‚
â”‚ (å¯é€‰)      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é£ä¹¦åŒæ­¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡å™¨ç«¯æ“ä½œ

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| 1 | è„šæœ¬éƒ¨ç½² | ä¸Šä¼  `zip_worker.py`ã€`annotation_checker.py` åˆ° `/tmp/` |
| 2 | çŠ¶æ€æ£€æŸ¥ | æ‰«æå·²æœ‰ ZIP å’Œå½“å‰ final_dirï¼Œè·³è¿‡é‡å¤å¤„ç† |
| 3 | ZIP å¤„ç† | è§£å‹ ZIPï¼Œç”¨æ–° JSON æ›¿æ¢æˆ–é‡å‘½åä¸º `annotations.json` |
| 4 | è´¨é‡æ£€æŸ¥ | æ‰§è¡Œæ ‡æ³¨æ£€æŸ¥ï¼Œç”ŸæˆæŠ¥å‘Šåˆ° `{process_dir}/reports/` |
| 5 | ç§»åŠ¨æ•°æ® | æ£€æŸ¥é€šè¿‡åç§»åŠ¨åˆ°æœ€ç»ˆç›®å½•ï¼ˆå·²å­˜åœ¨åˆ™è¦†ç›–ï¼‰ |
| 6 | æ¸…ç† ZIP | æ ¹æ®é…ç½®é‡å‘½åæˆ–åˆ é™¤åŸå§‹ ZIP æ–‡ä»¶ |

### æœåŠ¡å™¨ç›®å½•ç»“æ„

```
æœåŠ¡å™¨:
â”œâ”€â”€ {zip_dir}/              # ZIP å­˜æ”¾ç›®å½•
â”‚   â”œâ”€â”€ xxx.zip             # å¾…å¤„ç†
â”‚   â””â”€â”€ processed_xxx.zip   # å·²å¤„ç†ï¼ˆé…ç½®ä¸º rename æ—¶ï¼‰
â”‚
â”œâ”€â”€ {process_dir}/          # å¤„ç†ä¸­ç›®å½•
â”‚   â”œâ”€â”€ {stem}/             # è§£å‹åçš„æ•°æ®
â”‚   â””â”€â”€ reports/            # æ£€æŸ¥æŠ¥å‘Š
â”‚       â””â”€â”€ report_{stem}.txt
â”‚
â””â”€â”€ {final_dir}/            # æœ€ç»ˆç›®å½•ï¼ˆæ£€æŸ¥é€šè¿‡åï¼‰
    â””â”€â”€ {stem}/             # å®Œæˆçš„æ•°æ®
```

---

## ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§ä¿æŠ¤

### æ–­ç‚¹ç»­ä¼ æœºåˆ¶

#### ä¸‹è½½å®Œæ•´æ€§
- âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šä½¿ç”¨ `.downloading` ä¸´æ—¶æ–‡ä»¶æ ‡è®°
- âœ… **åˆ†æ®µéªŒè¯**ï¼šéªŒè¯å·²ä¸‹è½½éƒ¨åˆ†çš„ MD5
- âœ… **æ–‡ä»¶å¤§å°éªŒè¯**ï¼šä¸‹è½½å®ŒæˆåéªŒè¯æ–‡ä»¶å¤§å°
- âœ… **æœ€ç»ˆ MD5 éªŒè¯**ï¼šè®¡ç®—å®Œæ•´æ–‡ä»¶ MD5 å¹¶ä¸æœåŠ¡å™¨å¯¹æ¯”
- âœ… **ZIP å®Œæ•´æ€§**ï¼šä½¿ç”¨ `zipfile.testzip()` éªŒè¯ CRC æ ¡éªŒ
- âœ… **åŸå­æ“ä½œ**ï¼šéªŒè¯é€šè¿‡åæ‰é‡å‘½åä¸ºæ­£å¼æ–‡ä»¶

#### ä¸Šä¼ å®Œæ•´æ€§
- âœ… **æ–­ç‚¹ç»­ä¼ **ï¼šä½¿ç”¨ `.uploading` ä¸´æ—¶æ–‡ä»¶æ ‡è®°
- âœ… **åˆ†æ®µéªŒè¯**ï¼šéªŒè¯å·²ä¸Šä¼ éƒ¨åˆ†çš„ MD5
- âœ… **æ–‡ä»¶å¤§å°éªŒè¯**ï¼šä¸Šä¼ å®ŒæˆåéªŒè¯æ–‡ä»¶å¤§å°
- âœ… **æœ€ç»ˆ MD5 éªŒè¯**ï¼šè®¡ç®—å®Œæ•´æ–‡ä»¶ MD5 å¹¶ä¸æœ¬åœ°å¯¹æ¯”
- âœ… **åŸå­æ“ä½œ**ï¼šéªŒè¯é€šè¿‡åæ‰é‡å‘½åä¸ºæ­£å¼æ–‡ä»¶

### æ–­ç‚¹ç»­ä¼ æµç¨‹

```
1. æ£€æµ‹ä¸´æ—¶æ–‡ä»¶ (.downloading / .uploading)
   â†“
2. è·å–å·²ä¼ è¾“å¤§å°
   â†“
3. éªŒè¯å·²ä¼ è¾“éƒ¨åˆ†çš„ MD5 â­ å…³é”®æ­¥éª¤
   â†“
4. MD5 åŒ¹é…ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ä»æ–­ç‚¹ç»§ç»­ä¼ è¾“
   â””â”€ å¦ â†’ åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œé‡æ–°å¼€å§‹
   â†“
5. ä¼ è¾“å®ŒæˆåéªŒè¯æ–‡ä»¶å¤§å°
   â†“
6. æœ€ç»ˆéªŒè¯å®Œæ•´æ–‡ä»¶ MD5
   â†“
7. éªŒè¯é€šè¿‡ â†’ é‡å‘½åä¸ºæ­£å¼æ–‡ä»¶
```

### å¼‚å¸¸å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ | æ¢å¤ç­–ç•¥ |
|------|----------|----------|
| ä¸‹è½½ä¸­æ–­ | ä¿ç•™ `.downloading` ä¸´æ—¶æ–‡ä»¶ | ä¸‹æ¬¡è‡ªåŠ¨ç»§ç»­ |
| ä¸Šä¼ ä¸­æ–­ | ä¿ç•™ `.uploading` ä¸´æ—¶æ–‡ä»¶ | ä¸‹æ¬¡è‡ªåŠ¨ç»§ç»­ |
| MD5 ä¸åŒ¹é… | åˆ é™¤ä¸´æ—¶æ–‡ä»¶ | é‡æ–°ä¼ è¾“ |
| SSH æ–­å¼€ | è‡ªåŠ¨é‡è¿ | ç»§ç»­å¤„ç† |
| æœåŠ¡å™¨å·²å­˜åœ¨ | è·³è¿‡ä¸Šä¼  | ç»§ç»­å¤„ç† |

---

## ğŸ“Š é£ä¹¦è¿½è¸ª

### åŠŸèƒ½ç‰¹æ€§

- âœ… **å®æ—¶åŒæ­¥**ï¼šæ¯å®Œæˆä¸€ä¸ªæ•°æ®åŒ…ç«‹å³åŒæ­¥é£ä¹¦
- âœ… **æ™ºèƒ½åŒ¹é…**ï¼šæŒ‰"æ•°æ®åŒ…åç§°"å­—æ®µåŒ¹é…ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼ˆæ—¶é—´æ®µï¼‰
- âœ… **å±æ€§ç´¯ç§¯**ï¼šä¿ç•™åŸæœ‰å±æ€§æ ‡è®°ï¼Œæ–°å¢å½“å‰å±æ€§
- âœ… **è·¯å¾„ç´¯ç§¯**ï¼šä¿ç•™åŸæœ‰è·¯å¾„æ ‡è®°ï¼Œæ–°å¢å½“å‰è·¯å¾„
- âœ… **åŠ¨æ€è·¯å¾„æ˜ å°„**ï¼šè‡ªåŠ¨ä» `pipeline.yaml` è¯»å– `final_dir` å¹¶è½¬æ¢ä¸ºé£ä¹¦åˆ—å

### è®°å½•å­—æ®µ

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| æ•°æ®åŒ…åç§° | æ•°æ®åŒ…æ ‡è¯† | `20251226_171321-171500` |
| æ ‡æ³¨æƒ…å†µ | å¤„ç†çŠ¶æ€ | `å·²å®Œæˆ` / `æ£€æŸ¥ä¸é€šè¿‡` |
| å…³é”®å¸§æ•° | å…³é”®å¸§æ•°é‡ | `150` |
| å±æ€§æ ‡è®° | æ•°æ®å±æ€§ï¼ˆç´¯ç§¯ï¼‰ | `æ‹‰æ¡†å±æ€§=True`, `ç›²åŒºå±æ€§=True` |
| è·¯å¾„æ ‡è®° | ä¸Šä¼ è·¯å¾„ï¼ˆç´¯ç§¯ï¼‰ | `ä¸Šä¼ data02/dataset/scenesnew=True` |
| æ›´æ–°æ—¶é—´ | æœ€åæ›´æ–°æ—¶é—´ | `2026-01-14 12:30:00` |

### å±æ€§å’Œè·¯å¾„ç´¯ç§¯ç¤ºä¾‹

**ç¬¬ä¸€æ¬¡å¤„ç†**ï¼š
- json_dir åŒ…å«"æ‹‰æ¡†"
- final_dir æ˜¯ `/data02/dataset/scenesnew`
- é£ä¹¦æ ‡è®°ï¼š`æ‹‰æ¡†å±æ€§=True`, `ä¸Šä¼ data02/dataset/scenesnew=True`

**ç¬¬äºŒæ¬¡å¤„ç†**ï¼š
- json_dir åŒ…å«"ç›²åŒº"
- final_dir æ˜¯ `/data02/dataset/lines`
- é£ä¹¦æ ‡è®°ï¼š`æ‹‰æ¡†å±æ€§=True`, `ç›²åŒºå±æ€§=True`, `ä¸Šä¼ data02/dataset/scenesnew=True`, `ä¸Šä¼ data02/dataset/lines=True`

---

## ğŸ’¾ NAS å¤‡ä»½

### åŠŸèƒ½ç‰¹æ€§

- âœ… è‡ªåŠ¨æŒ‚è½½/å¸è½½ NAS å…±äº«ç›®å½•
- âœ… æ”¯æŒè·¯å¾„æ˜ å°„ï¼ˆæ ¹æ® final_dir è‡ªåŠ¨é€‰æ‹©å¤‡ä»½ç›®æ ‡ï¼‰
- âœ… ä½¿ç”¨ rsync å¢é‡å¤‡ä»½ï¼Œé«˜æ•ˆå¯é 
- âœ… å¤±è´¥è‡ªåŠ¨é‡è¯•æœºåˆ¶
- âœ… å¤‡ä»½å®Œæˆåè‡ªåŠ¨å¸è½½ï¼ˆå¯é…ç½®ï¼‰
- âœ… è¯¦ç»†çš„å¤‡ä»½æ—¥å¿—å’Œè¿›åº¦è¿½è¸ª

### é…ç½®ç¤ºä¾‹

```yaml
nas:
  enabled: true
  host: "192.168.2.41"
  share: "public"
  username: "SYSC"
  
  mount:
    local_mount_point: "/mnt/nas_backup"
    options: "vers=3.0,uid=1000,gid=1000"
    auto_unmount: true

path_mappings:
  "/data02/dataset/scenesnew": "from_rere/boxes"
  "/data02/dataset/lines": "from_rere/lines"

backup:
  mode: "incremental"
  timing: "after_each"
  rsync_options:
    - "-av"
    - "--progress"
    - "--delete"
  retry_count: 2
  retry_delay: 5
```

### ç³»ç»Ÿè¦æ±‚

```bash
# å®‰è£… CIFS å·¥å…·
sudo apt install cifs-utils

# é…ç½® sudo å…å¯†ç ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
sudo visudo
# æ·»åŠ ï¼šyour_username ALL=(ALL) NOPASSWD: /bin/mount, /bin/umount
```

---

## ğŸ› ï¸ è¾…åŠ©å·¥å…·

### 1. DataWeave ä¸Šä¼ å·¥å…·

ç”¨äºä»æœ¬åœ°è·¯å¾„æ‰«æ ZIP æ–‡ä»¶å¹¶ä¸Šä¼ åˆ° DataWeave æŒ‡å®šç›®å½•ã€‚

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶
python tools/upload_to_dataweave.py

# æŒ‡å®šå‚æ•°
python tools/upload_to_dataweave.py \
  --local /media/zgw/T7/zips \
  --target "dataweave://my/TO_RERE/æœªä¸Šä¼ å¹³å°"

# å¯ç”¨è°ƒè¯•æ¨¡å¼
python tools/upload_to_dataweave.py --debug
```

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… é€’å½’æœç´¢æ‰€æœ‰å­ç›®å½•ä¸­çš„ ZIP æ–‡ä»¶
- âœ… è‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤ä¸Šä¼ 
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆ3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
- âœ… åŠ¨æ€è¶…æ—¶è°ƒæ•´ï¼ˆæ ¹æ®æ–‡ä»¶å¤§å°ï¼‰
- âœ… Session è¿æ¥å¤ç”¨ï¼Œæé«˜ç¨³å®šæ€§

### 2. ZIP æ–‡ä»¶æ•´ç†å·¥å…·

å°†æ‰€æœ‰å­ç›®å½•ä¸­çš„ ZIP æ–‡ä»¶æ•´ç†åˆ°ä¸€ä¸ªç›®å½•ä¸­ã€‚

```bash
# ç§»åŠ¨æ–‡ä»¶
python tools/organize_zips.py \
  --source /media/zgw/T71/0107out/ \
  --target /media/zgw/T71/all_zips/

# å¤åˆ¶æ–‡ä»¶ï¼ˆä¿ç•™åŸæ–‡ä»¶ï¼‰
python tools/organize_zips.py \
  --source /media/zgw/T71/0107out/ \
  --target /media/zgw/T71/all_zips/ \
  --copy
```

### 3. NAS å¤‡ä»½å·¥å…·

ç‹¬ç«‹çš„ NAS å¤‡ä»½å·¥å…·ï¼Œå¯å•ç‹¬ä½¿ç”¨ã€‚

```bash
python tools/backup_to_nas.py \
  --source /data02/dataset/scenesnew/20251226_171321-171500 \
  --config configs/nas_backup.yaml
```

### 4. æ ‡æ³¨ç»Ÿè®¡å·¥å…·

ç»Ÿè®¡æ ‡æ³¨æ•°æ®çš„å…³é”®å¸§æ•°é‡ã€‚

```bash
python tools/annotation_stats.py --dir /path/to/data
```

### 5. é£ä¹¦è°ƒè¯•å·¥å…·

è°ƒè¯•é£ä¹¦è¡¨æ ¼è¿æ¥å’Œæ•°æ®åŒæ­¥ã€‚

```bash
python tools/debug_feishu.py
```

---

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. SSH è¿æ¥å¤±è´¥

**é—®é¢˜**ï¼š`SSH æœªè¿æ¥ï¼Œæ— æ³•ä¸Šä¼ `

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ SSH å¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æœåŠ¡å™¨ IP å’Œç«¯å£å¯è®¿é—®
- ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¿ï¼Œé€šå¸¸æ— éœ€æ‰‹åŠ¨å¹²é¢„

#### 2. ä¸‹è½½å¤±è´¥

**é—®é¢˜**ï¼š`æ— æ³•è·å–ä¸‹è½½URL`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ DataWeave å‡­è¯æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ–‡ä»¶åœ¨ DataWeave ä¸­å­˜åœ¨
- ç³»ç»Ÿæ”¯æŒæ–‡ä»¶åè§„èŒƒåŒ–ï¼Œä¼šè‡ªåŠ¨å¤„ç†å¸¦åç¼€çš„æ–‡ä»¶å

#### 3. NAS æŒ‚è½½å¤±è´¥

**é—®é¢˜**ï¼š`NAS æŒ‚è½½å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ cifs-utils æ˜¯å¦å®‰è£…
sudo apt install cifs-utils

# æ£€æŸ¥ NAS æ˜¯å¦å¯è®¿é—®
ping 192.168.2.41

# æ‰‹åŠ¨æµ‹è¯•æŒ‚è½½
sudo mount -t cifs //192.168.2.41/public /mnt/test \
  -o username=SYSC,password=xxx,vers=3.0
```

#### 4. é£ä¹¦åŒæ­¥å¤±è´¥

**é—®é¢˜**ï¼š`é£ä¹¦åŒæ­¥å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥é£ä¹¦åº”ç”¨å‡­è¯æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ app_token å’Œ table_id æ˜¯å¦æ­£ç¡®
- ä½¿ç”¨ `tools/debug_feishu.py` è°ƒè¯•è¿æ¥

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœ¬åœ°æ—¥å¿—
tail -f ~/.annotapipe/logs/pipeline.log

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
ssh user@server "tail -f /data02/logs/pipeline.log"
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.2 (2026-01-19)

**é¡¹ç›®æ¸…ç†**ï¼š
- ğŸ§¹ åˆ é™¤æ ¹ç›®å½•çš„å¤‡ä»½æ—¥å¿—æ–‡ä»¶
- ğŸ§¹ åˆ é™¤æ ¹ç›®å½•çš„ä¸´æ—¶æµ‹è¯•æ–‡ä»¶
- ğŸ§¹ æ¸…ç† Python ç¼“å­˜ç›®å½•
- ğŸ“ ä¼˜åŒ–é¡¹ç›®ç»“æ„ï¼Œæé«˜å¯ç»´æŠ¤æ€§

### v1.0.1 (2026-01-14)

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ¨ æ–‡ä»¶åè§„èŒƒåŒ–ï¼šè‡ªåŠ¨å¤„ç†å¸¦åç¼€çš„æ–‡ä»¶åï¼ˆå¦‚ `_rere_0`ï¼‰
- âœ¨ SSH è‡ªåŠ¨é‡è¿ï¼šæ£€æµ‹åˆ°è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿
- âœ¨ è¿æ¥ä½œç”¨åŸŸä¿®å¤ï¼šç¡®ä¿ SSH è¿æ¥åœ¨æ•´ä¸ªå¤„ç†æµç¨‹ä¸­ä¿æŒæ‰“å¼€

**æ”¹è¿›**ï¼š
- ğŸ”§ ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
- ğŸ”§ æ”¹è¿›æ–­ç‚¹ç»­ä¼ çš„å¯é æ€§
- ğŸ“š æ›´æ–°æ–‡æ¡£ï¼Œæ·»åŠ æ•…éšœæ’é™¤ç« èŠ‚

### v1.0.0 (2026-01-10)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ğŸš€ å¤šç§è¿è¡Œæ¨¡å¼ï¼ˆoptimized/parallel/streamingï¼‰
- ğŸ“¥ æ–­ç‚¹ç»­ä¼ ä¸‹è½½
- ğŸ“¤ æ–­ç‚¹ç»­ä¼ ä¸Šä¼ 
- ğŸ” æ ‡æ³¨è´¨é‡æ£€æŸ¥
- ğŸ“Š é£ä¹¦å®æ—¶åŒæ­¥
- ğŸ’¾ NAS è‡ªåŠ¨å¤‡ä»½

---

## ğŸ“– æ›´å¤šæ–‡æ¡£

- [Pipeline æ¨¡å—è¯¦è§£](src/pipeline/README.md)
- [é…ç½®æ–‡ä»¶è¯´æ˜](configs/README.md)

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## ğŸ“„ License

MIT License - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## ğŸ‘¥ ä½œè€…

EDuAPo Team

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ä¸ºè¿™ä¸ªé¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼
